/* 
 *  University of Washington EEP 598/CSEP 590: Neural Devices, Systems, and Computation
 *  Project 2 - Distributed System Firmware
 *  Written by Jeffrey Herron, Cory Lam, and Ember Chow
 */

#include <avr/wdt.h>  // Header for watchdog timers
#include <avr/pgmspace.h>  // Allows you to read in data from flash memory

constexpr unsigned long BAUDRATE = 115200;

// Length of buffers
constexpr unsigned int MAX_HEADER_LENGTH = 6;
constexpr unsigned int MAX_PAYLOAD_LENGTH = 249;

// Storage units to keep track of input message
constexpr byte expectedHeaderSync[3] = {0xAA, 0x01, 0x02};

constexpr unsigned long STREAM_PERIOD_MICROS = 2000;

unsigned int eeg_index = 0;
constexpr unsigned int EEG_DATA_LENGTH = 4925; 

// Arduinos, by default, make a copy of constant data into SRAM for quick access.
// PROGMEM tells the Arduino not to make a copy of this array into SRAM (use pgmspace functions to access instead!)
// Good thing too, because 9850 bytes is more than the capacity of the Arduino's SRAM!
constexpr unsigned short EEG_DATA[EEG_DATA_LENGTH] PROGMEM = {
    29595, 29743, 29513, 29184, 29151, 29163, 29710, 29911, 30245, 30019, 30846, 31499, 31738, 32502, 32681, 
    33380, 34085, 34634, 35884, 36224, 37391, 37771, 38809, 39579, 40173, 41157, 41559, 41861, 42136, 42803, 
    43193, 43459, 44073, 44247, 44350, 44485, 44807, 45245, 45884, 46045, 46356, 46761, 46797, 47784, 48213, 
    48713, 49055, 49217, 49504, 49907, 50357, 50061, 50391, 50299, 50231, 50073, 50921, 50591, 50687, 50840, 
    51024, 50934, 50818, 50905, 50503, 50533, 50015, 50461, 50093, 49965, 49878, 50180, 50029, 50296, 50179, 
    49815, 49804, 50070, 50023, 50093, 50296, 49861, 50475, 50767, 50843, 51044, 51264, 52153, 52763, 53143, 
    53423, 53530, 54226, 54418, 54802, 54669, 54815, 55202, 55181, 54702, 55075, 54847, 54630, 54612, 54106, 
    54040, 53946, 53270, 52935, 52749, 52518, 52240, 51809, 51884, 51578, 51606, 51511, 51591, 51235, 51438, 
    51357, 51160, 51219, 50969, 50682, 50481, 50261, 49990, 50079, 49070, 48466, 48589, 48338, 47754, 47775, 
    46971, 47015, 47018, 46982, 46566, 46876, 46662, 46526, 46501, 46690, 46564, 46397, 46658, 46931, 46478, 
    46556, 46119, 46013, 45790, 45659, 45112, 45160, 45322, 44699, 44863, 44363, 43895, 44071, 43685, 43720, 
    43848, 43500, 43434, 42973, 42990, 42722, 42415, 42243, 41774, 42085, 41739, 41815, 42220, 42524, 43036, 
    43733, 43831, 44177, 44286, 44574, 44794, 44408, 44679, 44765, 44575, 44818, 44574, 44360, 44293, 43832, 
    43760, 43067, 42533, 42597, 41869, 42325, 41102, 40782, 40667, 40261, 39822, 39430, 39046, 38479, 38382, 
    38155, 38407, 38116, 37537, 37412, 36696, 36483, 36590, 36775, 36242, 35932, 35782, 35748, 35603, 35203, 
    35073, 35024, 34830, 34678, 34831, 34238, 33640, 33703, 33814, 33725, 33515, 33525, 33352, 32963, 32870, 
    32685, 32325, 32314, 31841, 31536, 31485, 31122, 30969, 31001, 30714, 30540, 30358, 30130, 29710, 29274, 
    28757, 28960, 29009, 28771, 28247, 28032, 27469, 27244, 26620, 25839, 25792, 25169, 24934, 24777, 24593, 
    24957, 24722, 24492, 24711, 24965, 25506, 25242, 25368, 25555, 25714, 26105, 25721, 25654, 25903, 25936, 
    25908, 26004, 25833, 26294, 26016, 25941, 25661, 25719, 25105, 24964, 25087, 25473, 25064, 25649, 25438, 
    25392, 26076, 26355, 26456, 26715, 26859, 26958, 27020, 27172, 27427, 26907, 27114, 27479, 27675, 27871, 
    27961, 27944, 28226, 27859, 28066, 27500, 27521, 27561, 27541, 27509, 27511, 27401, 27488, 27547, 27497, 
    27468, 27699, 27906, 27791, 27633, 28060, 28024, 28633, 28785, 28865, 28879, 29216, 29652, 29906, 30349, 
    30654, 31197, 31480, 31959, 32797, 32601, 32522, 32616, 32010, 31806, 32074, 32041, 31348, 31351, 31409, 
    31796, 32315, 32914, 33665, 34238, 34662, 35289, 35848, 36017, 36125, 35866, 35349, 34765, 34356, 34388, 
    34285, 34256, 34990, 36096, 37324, 38382, 39903, 41099, 42526, 44270, 46063, 47523, 49154, 50047, 50491, 
    50634, 50606, 50565, 50089, 48959, 47458, 45708, 43800, 41518, 39146, 36742, 34647, 32416, 30049, 27981, 
    26445, 24245, 22175, 20767, 18953, 16862, 15167, 13601, 12394, 10962, 9905, 8473, 7615, 6281, 5730, 
    5049, 4207, 3848, 3448, 2742, 2084, 2229, 1923, 1915, 2072, 1715, 2654, 2343, 2487, 2893, 
    2657, 3379, 3432, 3882, 4578, 4859, 5234, 4991, 5346, 6321, 6440, 7172, 7484, 8161, 8789, 
    8951, 9379, 9662, 9968, 10229, 11268, 11462, 12119, 12563, 12932, 12933, 13528, 13740, 14174, 14281, 
    15309, 15670, 16045, 16433, 16619, 16921, 17644, 17704, 18087, 18228, 18440, 18479, 18721, 18982, 19264, 
    19561, 19666, 20314, 20416, 20520, 20733, 21399, 21530, 21357, 21349, 22017, 22022, 22045, 22327, 22887, 
    23146, 23399, 23750, 23908, 23901, 24233, 23740, 24119, 23906, 23642, 23603, 24185, 24357, 24505, 24478, 
    24884, 24794, 25260, 25393, 25699, 25853, 26128, 26223, 26457, 26571, 26671, 26666, 26818, 27197, 26938, 
    26579, 26305, 26200, 26101, 25940, 25912, 26007, 25685, 25592, 25564, 25689, 25793, 25835, 25542, 26065, 
    26313, 26209, 25963, 26214, 26382, 26697, 26757, 26647, 27320, 27088, 27500, 28449, 27974, 28160, 28325, 
    28535, 28527, 27970, 28394, 28715, 28255, 28111, 28092, 28064, 27957, 28095, 28680, 28633, 29004, 29099, 
    29511, 29714, 30343, 31390, 32561, 34416, 35463, 37012, 38535, 40128, 41032, 42610, 43083, 43992, 43568, 
    44482, 43784, 43097, 42404, 41565, 40494, 39338, 38115, 36648, 35439, 34433, 33246, 32392, 31656, 30841, 
    29740, 29262, 28484, 28279, 27307, 27369, 26958, 26710, 27280, 27347, 27745, 27262, 27907, 27975, 28362, 
    28768, 29298, 29482, 29862, 29984, 30414, 31685, 32391, 33178, 34068, 34932, 35794, 36456, 37402, 37934, 
    38603, 39296, 39586, 39773, 39642, 39960, 40128, 40300, 40391, 40370, 40714, 40715, 40608, 40362, 40290, 
    39882, 39521, 39904, 39558, 39859, 39668, 39750, 39680, 40068, 40506, 39987, 40216, 40584, 40105, 39715, 
    40517, 40346, 40343, 40258, 40478, 40115, 40052, 40636, 40889, 40858, 41116, 40964, 41310, 41126, 41353, 
    41625, 41027, 41786, 41512, 41789, 42144, 42002, 42603, 42737, 43372, 43541, 43768, 43951, 44243, 44231, 
    44478, 45073, 45069, 44863, 44943, 44636, 44333, 43622, 43407, 42709, 42555, 42172, 41862, 41377, 41046, 
    40994, 41223, 41112, 41271, 41792, 42297, 42081, 42691, 43030, 43395, 43829, 43704, 43665, 43935, 43652, 
    43551, 43593, 43384, 42824, 42520, 42457, 42060, 41804, 41553, 41595, 41033, 40772, 40438, 40427, 39935, 
    39421, 38520, 38264, 37699, 37078, 36841, 36396, 36202, 35655, 35206, 35283, 35183, 35218, 35663, 35672, 
    36144, 35920, 35882, 36377, 36353, 36233, 36466, 36571, 37219, 37324, 37799, 37602, 37787, 38274, 38216, 
    38359, 38978, 39664, 39717, 40540, 41011, 41565, 42129, 42569, 42731, 42557, 42778, 42257, 41923, 41908, 
    41744, 41080, 39847, 39097, 38199, 37214, 36409, 35500, 34458, 33603, 32988, 31746, 30895, 30515, 29981, 
    28937, 28442, 28290, 27881, 27497, 27353, 27315, 27089, 26776, 27108, 26867, 26787, 26915, 27022, 27068, 
    26966, 26923, 26769, 26440, 26695, 27005, 27552, 27625, 27550, 27473, 27823, 28006, 28317, 28492, 29123, 
    29208, 29014, 29460, 30016, 30228, 30521, 30977, 31874, 32302, 32625, 33251, 33785, 34338, 34520, 35288, 
    36056, 36522, 37390, 37659, 38191, 38652, 39393, 39476, 39977, 40136, 40126, 40464, 40520, 40646, 40619, 
    40364, 40272, 39827, 39684, 39131, 38252, 38204, 37655, 37556, 37238, 37246, 37155, 36845, 37370, 37547, 
    37914, 38287, 38622, 38979, 39794, 39831, 39933, 40205, 40400, 40446, 40686, 40724, 41047, 41348, 41408, 
    41902, 41609, 41828, 42211, 42045, 42271, 42423, 42438, 42572, 42414, 42251, 42241, 42383, 42796, 42254, 
    42745, 43169, 43399, 43364, 43745, 43735, 44072, 43757, 44046, 44462, 44419, 44277, 45119, 45113, 44947, 
    44594, 43929, 43681, 43286, 43072, 42066, 41926, 41068, 40045, 39612, 39230, 38832, 38617, 38614, 38954, 
    39129, 39464, 39593, 40100, 40693, 41397, 42079, 43099, 43275, 43972, 44572, 44887, 45949, 46107, 46756, 
    47085, 47685, 47889, 48011, 48032, 47945, 47977, 47603, 47746, 47862, 47452, 47435, 46700, 45944, 45638, 
    45118, 44863, 44295, 43736, 43294, 42441, 41587, 40785, 39838, 39296, 38364, 36570, 36053, 34795, 34065, 
    32463, 32063, 31045, 30046, 28956, 28481, 28022, 27734, 27273, 26910, 26288, 26411, 26263, 25838, 25625, 
    25786, 25548, 25886, 25480, 26604, 26750, 27214, 27475, 27876, 28385, 28973, 29350, 29556, 30243, 30784, 
    30487, 31220, 31224, 31664, 32223, 32276, 32682, 32992, 32926, 33235, 33551, 33419, 33362, 33523, 33889, 
    33608, 33857, 34284, 34268, 34651, 34699, 34428, 34751, 34768, 34172, 34260, 34610, 34208, 34165, 34195, 
    33818, 33736, 33941, 33819, 33330, 33676, 33795, 33616, 33586, 33659, 33726, 33627, 33587, 33948, 33704, 
    33907, 33692, 33637, 33517, 33654, 33810, 33954, 34446, 34219, 34424, 34388, 34956, 35036, 35112, 35419, 
    35403, 35219, 35437, 35861, 35895, 35810, 35549, 35802, 35611, 35720, 35530, 35376, 35155, 35307, 34820, 
    35053, 35349, 34978, 34982, 34985, 34801, 34998, 34986, 34954, 34919, 34842, 34519, 34736, 35113, 35184, 
    35481, 35632, 35504, 35551, 36193, 36366, 36605, 36416, 36949, 37150, 37385, 37583, 38045, 37975, 38574, 
    38541, 39275, 39695, 39958, 40027, 40311, 40433, 40253, 40250, 40886, 41485, 41837, 42190, 42749, 43691, 
    43925, 44737, 45712, 46980, 47649, 48579, 50086, 50818, 52260, 53034, 53672, 54643, 54926, 54955, 54894, 
    54866, 54953, 54937, 54358, 54066, 53406, 52598, 51847, 51021, 50567, 49946, 49089, 48487, 47938, 46601, 
    45854, 45051, 44534, 43942, 43223, 42719, 41572, 41266, 40617, 40361, 39794, 39298, 38977, 38557, 37748, 
    37468, 37426, 37429, 37659, 37553, 37852, 38276, 38517, 38347, 38846, 38935, 39558, 40105, 40507, 41421, 
    41502, 42003, 42637, 43227, 43534, 44078, 44645, 44982, 44997, 45448, 45788, 45903, 45963, 46852, 47098, 
    47561, 47371, 47368, 48205, 48441, 49319, 49857, 50200, 50445, 50684, 50892, 50784, 51585, 51413, 51572, 
    51642, 51629, 51655, 52012, 52011, 51819, 51582, 51237, 51571, 51041, 51361, 51321, 51412, 51323, 51427, 
    50839, 50921, 50830, 50534, 50221, 49980, 49759, 49776, 49305, 49396, 49170, 48676, 48790, 48814, 48964, 
    48765, 48820, 48973, 48788, 48828, 48478, 48565, 48460, 48352, 48279, 48392, 48099, 47669, 47718, 47666, 
    47391, 47314, 47073, 46847, 46684, 46361, 46406, 46390, 46428, 45957, 45875, 46229, 46419, 46375, 46584, 
    46564, 47024, 47467, 47681, 48067, 48205, 48635, 48771, 49056, 49338, 49222, 48741, 48637, 48764, 48164, 
    48216, 47919, 47498, 46975, 46666, 46947, 46841, 46586, 47635, 48108, 48405, 48766, 49870, 51495, 52914, 
    53956, 55488, 57213, 59187, 60663, 62290, 63315, 64443, 64660, 0, 65004, 64575, 64065, 62468, 61066, 
    59240, 57158, 55116, 53431, 51489, 49588, 47309, 45278, 43704, 41593, 39324, 37215, 34840, 32609, 30501, 
    28485, 26675, 24432, 22544, 20888, 18691, 16743, 15322, 13243, 11926, 10595, 9100, 7867, 6993, 6045, 
    4917, 3841, 3506, 2644, 2034, 1508, 772, 674, 593, 0, 307, 57, 337, 438, 700, 
    874, 1550, 2161, 2132, 2256, 2568, 3241, 3440, 3647, 4050, 4548, 4903, 5514, 6029, 6710, 
    7312, 7423, 7944, 8671, 9207, 9720, 10302, 10898, 11533, 11737, 12477, 12570, 13210, 13407, 13534, 
    13947, 14253, 14274, 14625, 15046, 15482, 16115, 16615, 16388, 16878, 17171, 17346, 17877, 18035, 18706, 
    18614, 19239, 19960, 20405, 21102, 21345, 21486, 22219, 22536, 22760, 23207, 23735, 24457, 24843, 25232, 
    25980, 26869, 26630, 27361, 27547, 27919, 27876, 28123, 28355, 28361, 29057, 29504, 29698, 30301, 31132, 
    31500, 31874, 32296, 32676, 33038, 33141, 33524, 33935, 34287, 34781, 34599, 34601, 35186, 35428, 36183, 
    36618, 36747, 37428, 37748, 37961, 38802, 39186, 39519, 39749, 40136, 40400, 40645, 41098, 41506, 42175, 
    42390, 42552, 42787, 43013, 43549, 43435, 43315, 43798, 43745, 44040, 43777, 44177, 44090, 44064, 44458, 
    44255, 44558, 44004, 44206, 44389, 44164, 44624, 45138, 45096, 45640, 46407, 46878, 47646, 48534, 48649, 
    49227, 49817, 50048, 50418, 50729, 50412, 50785, 51111, 51126, 50923, 50913, 50330, 50010, 49283, 49371, 
    48932, 48600, 48222, 48060, 48020, 47822, 47925, 47796, 48115, 48593, 48582, 48899, 48878, 49307, 49432, 
    49252, 49371, 49303, 49490, 49485, 49331, 48993, 49382, 49254, 49284, 48740, 48606, 48454, 48467, 48431, 
    48371, 48430, 48497, 48660, 48628, 48813, 48963, 49180, 49086, 49418, 49205, 49476, 49585, 49413, 49095, 
    49865, 49727, 49542, 49667, 49427, 49214, 49238, 48873, 48563, 48327, 48343, 48018, 48051, 47696, 47769, 
    47963, 47791, 47753, 48083, 48481, 48633, 48157, 47837, 47779, 47079, 46922, 46441, 46127, 45417, 44985, 
    44088, 42901, 42225, 41665, 41154, 40589, 40072, 40065, 39708, 39425, 39352, 39515, 39429, 40139, 40388, 
    40628, 40570, 40933, 40990, 41437, 41352, 41664, 42491, 42379, 42668, 43055, 43576, 43737, 44194, 44090, 
    44633, 45360, 45563, 45470, 45367, 45568, 45548, 45440, 45681, 44769, 44479, 44213, 44189, 43628, 43321, 
    42715, 42040, 41668, 41619, 41742, 41031, 41104, 40592, 40511, 40282, 40083, 39861, 40264, 39721, 40381, 
    40089, 39550, 39293, 39529, 39686, 39888, 40299, 40443, 40618, 40425, 40653, 41039, 40718, 41063, 41592, 
    41866, 42339, 43219, 44277, 45299, 46052, 46714, 48079, 48881, 50183, 51004, 52261, 53536, 54471, 55652, 
    56113, 57297, 57818, 58248, 58068, 58196, 57913, 57682, 57280, 56530, 55046, 54353, 53548, 52468, 50948, 
    50020, 48525, 47801, 46348, 45345, 43721, 43088, 42151, 40974, 39989, 39389, 39049, 38567, 37707, 37362, 
    37701, 37411, 36985, 36684, 37153, 36913, 37134, 37083, 37038, 37348, 37880, 38359, 39077, 39597, 40226, 
    40473, 40734, 41637, 41524, 41986, 42211, 42129, 42410, 42580, 42967, 43035, 43744, 43596, 43555, 43156, 
    43833, 43544, 43445, 43627, 43240, 43759, 43409, 43496, 43854, 43773, 43546, 43809, 43721, 43861, 44355, 
    44741, 44775, 44669, 45079, 45057, 45664, 46100, 46518, 46821, 47070, 47801, 47740, 48078, 47916, 48305, 
    48443, 48509, 48377, 48942, 48783, 48804, 49154, 49337, 49695, 49473, 49928, 49482, 49468, 49418, 48862, 
    48723, 48200, 47874, 47514, 47394, 46490, 45902, 45188, 44287, 43382, 42800, 42721, 41727, 41193, 40022, 
    39853, 39560, 39272, 38731, 38593, 38541, 38499, 38330, 38083, 38670, 38120, 38145, 38043, 38222, 38180, 
    38140, 38288, 38343, 38199, 38930, 39254, 39051, 39423, 40278, 40443, 40666, 41118, 41342, 41796, 41503, 
    41177, 41436, 41331, 41338, 41076, 41048, 40570, 40208, 39728, 39542, 39107, 38761, 38071, 37817, 37170, 
    37023, 36437, 36170, 35302, 34938, 34437, 34622, 34419, 34505, 33925, 34027, 34376, 34761, 35093, 35076, 
    36030, 36947, 37950, 38789, 39983, 41006, 42102, 43471, 44158, 44441, 45434, 45576, 45472, 45539, 45113, 
    44795, 44221, 43580, 43010, 42179, 41461, 40302, 39294, 38520, 37661, 36998, 35895, 35332, 34261, 33899, 
    33262, 32605, 31918, 31586, 31074, 30430, 29337, 28957, 28817, 28062, 28289, 28292, 28355, 28241, 28954, 
    28871, 28995, 29305, 29553, 29583, 30184, 30656, 31214, 31161, 31421, 32145, 32512, 32895, 33351, 33952, 
    34263, 35065, 35511, 35422, 35914, 36562, 36327, 36378, 35695, 35285, 35413, 35076, 34700, 34433, 34220, 
    34077, 33996, 33768, 33694, 33719, 33770, 33566, 33318, 32831, 32535, 32465, 32226, 32174, 32249, 32650, 
    32844, 32977, 33650, 33452, 33915, 34115, 34835, 35109, 35260, 35141, 35221, 35335, 35265, 35071, 35132, 
    35142, 34577, 34415, 33715, 33857, 33550, 33413, 32996, 32814, 32789, 33100, 33575, 33634, 34032, 35555, 
    35712, 36215, 36926, 37687, 38411, 39174, 39569, 40505, 40737, 40736, 40941, 40963, 40787, 40360, 39977, 
    39311, 38238, 37149, 36649, 35615, 34460, 33455, 33263, 32863, 32267, 31874, 32218, 32415, 32408, 32296, 
    33008, 33474, 33662, 33798, 33763, 34084, 33900, 33792, 33696, 34111, 34530, 34810, 34893, 35196, 35108, 
    35601, 35758, 35943, 36455, 36705, 37158, 37457, 38020, 38144, 38706, 38588, 39035, 38700, 38371, 38133, 
    38384, 37783, 37362, 37118, 37040, 36069, 36170, 35584, 34987, 34247, 34515, 33953, 33707, 33708, 33705, 
    33556, 33613, 32994, 32238, 31656, 31680, 31225, 31356, 30673, 30419, 30217, 29966, 29694, 29483, 28761, 
    28482, 28139, 28103, 27867, 27689, 27742, 27711, 27673, 27412, 27916, 27872, 27737, 27874, 28056, 27902, 
    28537, 29158, 29955, 30716, 31136, 32387, 33402, 34640, 35929, 37685, 39907, 42547, 44114, 45923, 48381, 
    51558, 53491, 55072, 56948, 58874, 60230, 61180, 61784, 61998, 61793, 60591, 59578, 58199, 56656, 54927, 
    53020, 50366, 48245, 46166, 43765, 41824, 40114, 38298, 36416, 34425, 33021, 31210, 29945, 28551, 27656, 
    26498, 25166, 23861, 22787, 22479, 21520, 21121, 20557, 20168, 19644, 19813, 20512, 20655, 21357, 21754, 
    22128, 22728, 23208, 23911, 24275, 25488, 25775, 26406, 26793, 27188, 27923, 27909, 28261, 28926, 29223, 
    29247, 29808, 30712, 31054, 31320, 31698, 31982, 32308, 32665, 33032, 33209, 33443, 33691, 34180, 34310, 
    34427, 34495, 34633, 35397, 35398, 35544, 35085, 35515, 35521, 36129, 36345, 36582, 36751, 36774, 36993, 
    36894, 37283, 36942, 36996, 37040, 36854, 37032, 37245, 37274, 37404, 37334, 37139, 37354, 37112, 37120, 
    37220, 37282, 36975, 36577, 36771, 36370, 36004, 36180, 36134, 36048, 35795, 36067, 36060, 36102, 36192, 
    35639, 35925, 36091, 36035, 36287, 36208, 36289, 36836, 36869, 37375, 36894, 37557, 37848, 37775, 38243, 
    38208, 38422, 38484, 38508, 37918, 38522, 39034, 39662, 40331, 40530, 41342, 42115, 42968, 43501, 44243, 
    44662, 44650, 45633, 45700, 45281, 45689, 45711, 45820, 45183, 45017, 44743, 43799, 43692, 43917, 43226, 
    43150, 43163, 42488, 42381, 42366, 42034, 41490, 41874, 42098, 42282, 41836, 41719, 41838, 41970, 42083, 
    42469, 42058, 42291, 42423, 42299, 42563, 42986, 43039, 42698, 42875, 42919, 43337, 43111, 43180, 43411, 
    43604, 43621, 43576, 44080, 44021, 44369, 44668, 44566, 44773, 44448, 44470, 44825, 45072, 45062, 45524, 
    45871, 46317, 46249, 46225, 46151, 46083, 46057, 46346, 46071, 46264, 45577, 45311, 44635, 44088, 43442, 
    42601, 41973, 41166, 40385, 39964, 39317, 39388, 38487, 37975, 37294, 37585, 37216, 37446, 37480, 38260, 
    38597, 39340, 39914, 40767, 41376, 42370, 43221, 43905, 44334, 45042, 45324, 45583, 46218, 46425, 46822, 
    46628, 47112, 46987, 46830, 46384, 46447, 46022, 44950, 44446, 44048, 43552, 42818, 42109, 41772, 40926, 
    40471, 39719, 38766, 38289, 37977, 36885, 36591, 35836, 35829, 34994, 34489, 34158, 33733, 33452, 33387, 
    33083, 33760, 33158, 32992, 33248, 33143, 33418, 33407, 33385, 33441, 33327, 33285, 33343, 33008, 33185, 
    33588, 33645, 32998, 33381, 33246, 33409, 33145, 33160, 32972, 32817, 33111, 32670, 32447, 32530, 32338, 
    32260, 32679, 31955, 31812, 31582, 31650, 31620, 31613, 31652, 31475, 31037, 30849, 30617, 30880, 30411, 
    31023, 30538, 30604, 30724, 30621, 30342, 30043, 30194, 30363, 30542, 30782, 30660, 30475, 30872, 30534, 
    30912, 30599, 30498, 30872, 30402, 30172, 30236, 30904, 30839, 30995, 31139, 30853, 30842, 31390, 31279, 
    31190, 31737, 31617, 31557, 31897, 32129, 32049, 32172, 31979, 32084, 32487, 32168, 32215, 32809, 32653, 
    32776, 33205, 33548, 33851, 33534, 33920, 34289, 34199, 34508, 34561, 34936, 34866, 34933, 35048, 35382, 
    34996, 35371, 35497, 35899, 35523, 35612, 35675, 35677, 35911, 35957, 36103, 36200, 36256, 36240, 36572, 
    36307, 36155, 36621, 36486, 36137, 36766, 36848, 36664, 36748, 36664, 36656, 36685, 36311, 36614, 36732, 
    36900, 36446, 36124, 36029, 35805, 35628, 35439, 34995, 34855, 34815, 34550, 34098, 33463, 33266, 33184, 
    32807, 32935, 33252, 33135, 32872, 32545, 33249, 33686, 34061, 34589, 35077, 35453, 36163, 37317, 38013, 
    38514, 38779, 39332, 39899, 39917, 40058, 39828, 39689, 38850, 38800, 38061, 37792, 37061, 36400, 35745, 
    35567, 34828, 34107, 33585, 32438, 32055, 31919, 31380, 30971, 31008, 30388, 29974, 29226, 28922, 28584, 
    27854, 28088, 27972, 28173, 28370, 28026, 28531, 28808, 29163, 29614, 29896, 29952, 30713, 31233, 31726, 
    31961, 32195, 32701, 32702, 33003, 33071, 32707, 32624, 32701, 32261, 31973, 31792, 31521, 31426, 31007, 
    31132, 30419, 30189, 30089, 29987, 29861, 29659, 29999, 29852, 29465, 29773, 30287, 30247, 30258, 30668, 
    30779, 30873, 31143, 31930, 31977, 32428, 32864, 33149, 33445, 33605, 33580, 33272, 34028, 33783, 33769, 
    33701, 33638, 33513, 33233, 33153, 33495, 33373, 33269, 33597, 33620, 33512, 33461, 33668, 33590, 33627, 
    33470, 33592, 33489, 33409, 33187, 33131, 33291, 33403, 33385, 33358, 33289, 33682, 33441, 33193, 33349, 
    33647, 33699, 33452, 33628, 34329, 33833, 34048, 34144, 34414, 34294, 34725, 34387, 34944, 34851, 34735, 
    34486, 34843, 34926, 34674, 34209, 33872, 33670, 33946, 33701, 33800, 34445, 34644, 34965, 35404, 35479, 
    36101, 36597, 36776, 37270, 37985, 37881, 38239, 37893, 37987, 38072, 38332, 38143, 38355, 38162, 37983, 
    38234, 38502, 38486, 38287, 38307, 38265, 38298, 38658, 38655, 38162, 38390, 38449, 38577, 38697, 38964, 
    38957, 38848, 38938, 38840, 38843, 39158, 39550, 39969, 40337, 40770, 40932, 40638, 40989, 40998, 41174, 
    41407, 41452, 41651, 41669, 41640, 41130, 40649, 40389, 40050, 40036, 40132, 40169, 40860, 40960, 40788, 
    40681, 41240, 41478, 41845, 42225, 42083, 42759, 42683, 42944, 43059, 43074, 42797, 42962, 42363, 41997, 
    41912, 41783, 41083, 40866, 40946, 40623, 40837, 40179, 40346, 39915, 39921, 39638, 39656, 39599, 39765, 
    39378, 39329, 39024, 39009, 38850, 38595, 38555, 38100, 37970, 37834, 37963, 37369, 37513, 37159, 37092, 
    37380, 37326, 36776, 36643, 36294, 36604, 36723, 36681, 36875, 37174, 38106, 38288, 39321, 39591, 39688, 
    40234, 40332, 40367, 40213, 40560, 39899, 39624, 39292, 38880, 37888, 36669, 36291, 35955, 35484, 34603, 
    33925, 33527, 33094, 32523, 32823, 32736, 32206, 32379, 32200, 32186, 32151, 32210, 32017, 32254, 32390, 
    32633, 32631, 32607, 33186, 33443, 33200, 33717, 33668, 33686, 34058, 34046, 33951, 33967, 34416, 34487, 
    34879, 35186, 35679, 35694, 36126, 36430, 36586, 36733, 36902, 36793, 36549, 36027, 35982, 35717, 35342, 
    35106, 35391, 35478, 35211, 34882, 35217, 34951, 35287, 35344, 35581, 35597, 35461, 36178, 35897, 36002, 
    36672, 37030, 37226, 37066, 37440, 38027, 37833, 37831, 38599, 39849, 40807, 41962, 43355, 44644, 45883, 
    48164, 50030, 51350, 53697, 55841, 58017, 59433, 60575, 61756, 63019, 63609, 64371, 64234, 64180, 63835, 
    62728, 61714, 60349, 59000, 56996, 55424, 53299, 51582, 49742, 47803, 46240, 44376, 42616, 41318, 39565, 
    38359, 36583, 35546, 34555, 33388, 32411, 32117, 31677, 31423, 31138, 31061, 31451, 31564, 31927, 32296, 
    32724, 33268, 34364, 34302, 35141, 35521, 36219, 37120, 37894, 38379, 39067, 39434, 40253, 41096, 41486, 
    42210, 43174, 43547, 44073, 44676, 44688, 44942, 45745, 45964, 46830, 47271, 47199, 47700, 48127, 48430, 
    48851, 48818, 49124, 49613, 50066, 50057, 50421, 50107, 50290, 50415, 50720, 50843, 50519, 50309, 50600, 
    50316, 50678, 50585, 50500, 50097, 50226, 49734, 49747, 49218, 49311, 49059, 48673, 48337, 48586, 48251, 
    47989, 47925, 47315, 46734, 46526, 46551, 45805, 45700, 45236, 44616, 44545, 44281, 44271, 44108, 44091, 
    43845, 43450, 42851, 42980, 42648, 42877, 42185, 42507, 42293, 42509, 42143, 42470, 41910, 41974, 41955, 
    42315, 42287, 42645, 42717, 43253, 43781, 44265, 44419, 44611, 44928, 45815, 45967, 46258, 46327, 46692, 
    46687, 46818, 46615, 46446, 46133, 45960, 45170, 44796, 44452, 44086, 43869, 43300, 42959, 42614, 42035, 
    42283, 41640, 41109, 41071, 40944, 40904, 40367, 40362, 39872, 39732, 39399, 39421, 39009, 39032, 38814, 
    38672, 38860, 38684, 38764, 38925, 38794, 38831, 39184, 39227, 39664, 39553, 39703, 39581, 39297, 39505, 
    39774, 39980, 39865, 39778, 39824, 39610, 39563, 39283, 39234, 38903, 38906, 39059, 39139, 39412, 39577, 
    39289, 39485, 39328, 39346, 39081, 38953, 38928, 38483, 38697, 38330, 37598, 37949, 37605, 37283, 36504, 
    36704, 36463, 35700, 35270, 34836, 35137, 34541, 34235, 33829, 33830, 33865, 33733, 33838, 34401, 34091, 
    33566, 33901, 33863, 33771, 34013, 33900, 33819, 33468, 33231, 33427, 33592, 32703, 32825, 32943, 33055, 
    33092, 32830, 32881, 32865, 33200, 32625, 32633, 32716, 32834, 32694, 32247, 32050, 31786, 31466, 31494, 
    31337, 31487, 31229, 31623, 31623, 31595, 31336, 31476, 31305, 31230, 31043, 30421, 30047, 30021, 29970, 
    29578, 29723, 29787, 29999, 29751, 29774, 29987, 29938, 29991, 29899, 30143, 30119, 30190, 30459, 30504, 
    30921, 30847, 30957, 31232, 31426, 32168, 32204, 32659, 33490, 34100, 34405, 34931, 35722, 36373, 37009, 
    37525, 38317, 38147, 38864, 39524, 39741, 40510, 40656, 41045, 41494, 41502, 41325, 40655, 40254, 39219, 
    39101, 37811, 37538, 36414, 35382, 35018, 34469, 34011, 33774, 33248, 33235, 32719, 32691, 32326, 32311, 
    32637, 32581, 32064, 32177, 31827, 32142, 31988, 32212, 32167, 32876, 33037, 33407, 33473, 33696, 34315, 
    34874, 34589, 34977, 35714, 35814, 36288, 36857, 37116, 37733, 38200, 38910, 39298, 39538, 39735, 39968, 
    40706, 41130, 41229, 41652, 41927, 42139, 42787, 43475, 43849, 44244, 44763, 45075, 45361, 45774, 46055, 
    46531, 46618, 46651, 46651, 46387, 45699, 45972, 45953, 46145, 46410, 46464, 45906, 46154, 45668, 45755, 
    45873, 45464, 45257, 45019, 44902, 44535, 44881, 44731, 44671, 43847, 44221, 44217, 44167, 43769, 43495, 
    43928, 44117, 43633, 43531, 43651, 43057, 42742, 42795, 42734, 41675, 41480, 41396, 41216, 41166, 40846, 
    40948, 41446, 41585, 41822, 42120, 42413, 42720, 42577, 42762, 42442, 42392, 41943, 42259, 41934, 42126, 
    42093, 42500, 42433, 42290, 42745, 42719, 42770, 42637, 42597, 42380, 42338, 41990, 41713, 41376, 41356, 
    41112, 40810, 41038, 40844, 41057, 40298, 40160, 40075, 39788, 39740, 39624, 39549, 39652, 39927, 39929, 
    39559, 39498, 39222, 39103, 38856, 39271, 38932, 38590, 38765, 38570, 38781, 38650, 38453, 38588, 38389, 
    38314, 38290, 38378, 38503, 38818, 38409, 38402, 38695, 38697, 38834, 39256, 39525, 39471, 39590, 39789, 
    40836, 42496, 44558, 46801, 48834, 50819, 52847, 54858, 56956, 58747, 60170, 61142, 62170, 62501, 62615, 
    62879, 62223, 61707, 61294, 59646, 58179, 56476, 54540, 53036, 51087, 49303, 47756, 46475, 45152, 43152, 
    41821, 40309, 38399, 37082, 35582, 34148, 32913, 31964, 30784, 29829, 29630, 28967, 28498, 28509, 28135, 
    27578, 27438, 27355, 27248, 27731, 27876, 27624, 28545, 29031, 29562, 29959, 31102, 31256, 32072, 32846, 
    33715, 34058, 34685, 35599, 35940, 36584, 37234, 38211, 38443, 39173, 39703, 40278, 41015, 41420, 41807, 
    41878, 41932, 42012, 42792, 43419, 43660, 43622, 44373, 44667, 44767, 44729, 44983, 44969, 44920, 45219, 
    45110, 45256, 45184, 45289, 45548, 45893, 46119, 46493, 47050, 46941, 46180, 46514, 46259, 46180, 45956, 
    45238, 45329, 45159, 44708, 44621, 44627, 43791, 43534, 43092, 43247, 42543, 42469, 41978, 41538, 41475, 
    41035, 40650, 40135, 39940, 39859, 39692, 38934, 38978, 39079, 39059, 38339, 38421, 38512, 38285, 38602, 
    38815, 39162, 39100, 39306, 39526, 39621, 40083, 40388, 40432, 40553, 40585, 40710, 41088, 41100, 41072, 
    41253, 40630, 40825, 40489, 40374, 40067, 39958, 39697, 39587, 39830, 40045, 40124, 40044, 40176, 40138, 
    40216, 40069, 39341, 39251, 39251, 38310, 37721, 37512, 36864, 36564, 36526, 36469, 36063, 36862, 37262, 
    37652, 37660, 38601, 38763, 39260, 39539, 39879, 39961, 39778, 39926, 39804, 39802, 39898, 39788, 39422, 
    38894, 38150, 37942, 37503, 36462, 36416, 36025, 35815, 35069, 34914, 34444, 33765, 33555, 32473, 31668, 
    31177, 31153, 30395, 30114, 29830, 29843, 29398, 29159, 28672, 28571, 29123, 28832, 28961, 28655, 28362, 
    28637, 28371, 28213, 28185, 28503, 28792, 29365, 29388, 29617, 30365, 30868, 31152, 31537, 31425, 32196, 
    32695, 33427, 33400, 33877, 34183, 34484, 35429, 36218, 37139, 38087, 38709, 39969, 41179, 42166, 43569, 
    44878, 45479, 46643, 47498, 49069, 50638, 51271, 51693, 52410, 52772, 52689, 52835, 51727, 50549, 49833, 
    48650, 47306, 45926, 44440, 43602, 42079, 41424, 40007, 38799, 37813, 36684, 35722, 34787, 33643, 32979, 
    32435, 32021, 31955, 31551, 31610, 31699, 30935, 30596, 30442, 30409, 30639, 30479, 31094, 31057, 31236, 
    31885, 32455, 32687, 33108, 33296, 33317, 33936, 34320, 34351, 34836, 35009, 35246, 35966, 36718, 37330, 
    37884, 38221, 38353, 38771, 38992, 39776, 40336, 40685, 41874, 42531, 43073, 43625, 44185, 44842, 45166, 
    45705, 46017, 46402, 46606, 46381, 46476, 46549, 46215, 46680, 46818, 46551, 46851, 46067, 46348, 46081, 
    45961, 45576, 45477, 45135, 45486, 44547, 44383, 44334, 44390, 44232, 43537, 43603, 43327, 43001, 42913, 
    42473, 42312, 42425, 42139, 42106, 42195, 42260, 42483, 42268, 42278, 42499, 42572, 42834, 42866, 42960, 
    43428, 43402, 43476, 43470, 43483, 43850, 43712, 43915, 43994, 43840, 43508, 43561, 43532, 43582, 43968, 
    43988, 44659, 45072, 45406, 45386, 45202, 44772, 44575, 44246, 43331, 42683, 41750, 41365, 40537, 39586, 
    38610, 38262, 37499, 36944, 36224, 36102, 35569, 35392, 35249, 35051, 35045, 34726, 34449, 34583, 34493, 
    34540, 34337, 34169, 34345, 34713, 34894, 34876, 35311, 35207, 35539, 35747, 35503, 35757, 36041, 35761, 
    35794, 35650, 35001, 35097, 34929, 34528, 34490, 34672, 34407, 34298, 34253, 34588, 34643, 34274, 34314, 
    34527, 34634, 34772, 34592, 34941, 35005, 34992, 35253, 35212, 35689, 35883, 35916, 36502, 36415, 36486, 
    36177, 36225, 36167, 36271, 36028, 35942, 36661, 36586, 36876, 36655, 36427, 36398, 36208, 35812, 34910, 
    34049, 33190, 32858, 32034, 31513, 31021, 30610, 30153, 30106, 29529, 28738, 28853, 28162, 28018, 27581, 
    27311, 27200, 26844, 26773, 26540, 26353, 26401, 25963, 25762, 25981, 26100, 26615, 26303, 26939, 27076, 
    27872, 27935, 27994, 27991, 28141, 28678, 28923, 28794, 29313, 29442, 29667, 29666, 29771, 29620, 29048, 
    29108, 28817, 28236, 27812, 27660, 27821, 27135, 27096, 26980, 26925, 26545, 26617, 26371, 26653, 26608, 
    26589, 26516, 26730, 26285, 26064, 25975, 26075, 26261, 26493, 26293, 26557, 26763, 26838, 27088, 27342, 
    27044, 27302, 28177, 28246, 28419, 28667, 28319, 28435, 28626, 28811, 28658, 28752, 28843, 29092, 29190, 
    29295, 29194, 29563, 29929, 30018, 30114, 30227, 30450, 30100, 30017, 29844, 29358, 29371, 29378, 29268, 
    28879, 28855, 28404, 28827, 28848, 29480, 29555, 29760, 30221, 30786, 31072, 31338, 31096, 31039, 31285, 
    30923, 30930, 31006, 30714, 30706, 31088, 31129, 31087, 31115, 31449, 31079, 31311, 31448, 30734, 30696, 
    30681, 30621, 30114, 30205, 29580, 29866, 30388, 30120, 30474, 31142, 31153, 31297, 31004, 31465, 31652, 
    31473, 31530, 31241, 30702, 30877, 30925, 31182, 31277, 31887, 32134, 32076, 32479, 32419, 32141, 32278, 
    32123, 32195, 31817, 31487, 31504, 31719, 31703, 31818, 32171, 32442, 32517, 32710, 32985, 33029, 33546, 
    33844, 33519, 33455, 33446, 33442, 33083, 33159, 33373, 33425, 33573, 33059, 33385, 33280, 33399, 33362, 
    33361, 32899, 32585, 32428, 32234, 31536, 31484, 30985, 31379, 31082, 31180, 30839, 30941, 31006, 31150, 
    31172, 31014, 30623, 30878, 31266, 31069, 30940, 31106, 31052, 31135, 31326, 31398, 31289, 31668, 31407, 
    31664, 31115, 31058, 30702, 31096, 30690, 30689, 30764, 31044, 31017, 30929, 30832, 30927, 31094, 30830, 
    30750, 30797, 30814, 30684, 30012, 29900, 30078, 29796, 30076, 29966, 30302, 30318, 30546, 30346, 30557, 
    31283, 31499, 31805, 32660, 33509, 34195, 35261, 35744, 36366, 36384, 36614, 36474, 36882, 36835, 36431, 
    36146, 36267, 35720, 35448, 35435, 35027, 35312, 35528, 35432, 35818, 36250, 36587, 36776, 36988, 37960, 
    38418, 39193, 39215, 39430, 39502, 39470, 39627, 39980, 39900, 39650, 39818, 39570, 39227, 38842, 38476, 
    38111, 37818, 37490, 37456, 37045, 36490, 36477, 36226, 36436, 35966, 35680, 35407, 35198, 35650, 35635, 
    35999, 36371, 36845, 37481, 38160, 38563, 39676, 40489, 41171, 41667, 42159, 42765, 43152, 43943, 44438, 
    45226, 45255, 45371, 45192, 45514, 45305, 45165, 44936, 44447, 43574, 42938, 41676, 40309, 39413, 38303, 
    37458, 36840, 36191, 34842, 34449, 34274, 33977, 33343, 32678, 32432, 32073, 31570, 30994, 31130, 30624, 
    30518, 30201, 30568, 30928, 30973, 31076, 31633, 31438, 31602, 32096, 32301, 32231, 32499, 32836, 33022, 
    33589, 34025, 34619, 35006, 35476, 35820, 36050, 36458, 36852, 36926, 37119, 37547, 37495, 37316, 38039, 
    37546, 37776, 37824, 38337, 38299, 38568, 38406, 38604, 38810, 38913, 38829, 39129, 39583, 39772, 39778, 
    40366, 40490, 40458, 40049, 40136, 39764, 39769, 39571, 39644, 39359, 39469, 39585, 39972, 39574, 39612, 
    39215, 38762, 38706, 38350, 38549, 38399, 38139, 38105, 38182, 38099, 38353, 38224, 38397, 38528, 38269, 
    38151, 37792, 37067, 36703, 36255, 35852, 35472, 35294, 34682, 34559, 34817, 34329, 34833, 34678, 34658, 
    34816, 35556, 35832, 36781, 36720, 37381, 37462, 37767, 37443, 37780, 38271, 37848, 37228, 37163, 36622, 
    36584, 36243, 36063, 36102, 35806, 35298, 35027, 34992, 34891, 34986, 34523, 34380, 34096, 33653, 33186, 
    32691, 32078, 31665, 31152, 31117, 31048, 30686, 30378, 30613, 29995, 29465, 29618, 29261, 29270, 28706, 
    28945, 28549, 28294, 28205, 28684, 28765, 29319, 29359, 29548, 29297, 29458, 29350, 29827, 29783, 30092, 
    30064, 30506, 30340, 30602, 30556, 30339, 30089, 30062, 30736, 29978, 30242, 30653, 30659, 30761, 30782, 
    30718, 30584, 30653, 31000, 30380, 30685, 30643, 30987, 31162, 31700, 31462, 31084, 31266, 30850, 30656, 
    29918, 29708, 28315, 28120, 27456, 27097, 27119, 27663, 27574, 27297, 28113, 28807, 29329, 30171, 30478, 
    31262, 31767, 32993, 33953, 34775, 35720, 36672, 37510, 38922, 39974, 40457, 40979, 41752, 42705, 42994, 
    44069, 43952, 44214, 44228, 44271, 44040, 43083, 42582, 41671, 41113, 40280, 39314, 38524, 37315, 36363, 
    34687, 33383, 32032, 30951, 29564, 28853, 27772, 26901, 26098, 25538, 25042, 24479, 24007, 23592, 23104, 
    22753, 22120, 22078, 21912, 21854, 21392, 21780, 22012, 22154, 22754, 23019, 23575, 24193, 24557, 25204, 
    25687, 26127, 26807, 27660, 28077, 28966, 29153, 29909, 30514, 31319, 31859, 32955, 33695, 35013, 36093, 
    36707, 37983, 38948, 39943, 40972, 41514, 41671, 41617, 41353, 41390, 40798, 40273, 39765, 39508, 38869, 
    38198, 37903, 37465, 37070, 36743, 36306, 35735, 35624, 35006, 34433, 34081, 34011, 34197, 33925, 34719, 
    35057, 35434, 35621, 35868, 36760, 37644, 37745, 38695, 38815, 38959, 39392, 39440, 39687, 39092, 39115, 
    39060, 38788, 38843, 38790, 38862, 38636, 38720, 38555, 38935, 38953, 39270, 40012, 40314, 40648, 41142, 
    41755, 41332, 41976, 42127, 42784, 42750, 43432, 43084, 43242, 43010, 43061, 42766, 42865, 42521, 42688, 
    42117, 41406, 41608, 41588, 41414, 41219, 40724, 40633, 40219, 39873, 39859, 39523, 38866, 38643, 38131, 
    38427, 38362, 38206, 38482, 38507, 38162, 38414, 38451, 38335, 38558, 38235, 37781, 37948, 37813, 37704, 
    37482, 37357, 37485, 36895, 36888, 36742, 36378, 36162, 35928, 35988, 36101, 36005, 35983, 35974, 36187, 
    35499, 35137, 34939, 34573, 34439, 34183, 33382, 33542, 33923, 33931, 33704, 33461, 33432, 33578, 33326, 
    33709, 33667, 33535, 33104, 33305, 33138, 32976, 33053, 33522, 33500, 33913, 34664, 34705, 35137, 34863, 
    35443, 35603, 35306, 35618, 35645, 35738, 35617, 35092, 35477, 34478, 34423, 33885, 34112, 33509, 33672, 
    33077, 32939, 33032, 32718, 32672, 32142, 31948, 32018, 31797, 31523, 31408, 31813, 31609, 31413, 31464, 
    31988, 32010, 32432, 32742, 33273, 34065, 34188, 34884, 36061, 36385, 36642, 37355, 38749, 39716, 40505, 
    41967, 43536, 45087, 46179, 47800, 49301, 51086, 52350, 52981, 53902, 54530, 54848, 54902, 54944, 54601, 
    54970, 54002, 52821, 52138, 50659, 49202, 47928, 47192, 45566, 44003, 42805, 41715, 40217, 39285, 38598, 
    37838, 37059, 36306, 35749, 35425, 34770, 34680, 34650, 34688, 34542, 34822, 34677, 35303, 35356, 36204, 
    36603, 36560, 37633, 38177, 39122, 40248, 41056, 41736, 42986, 44253, 44591, 45599, 46289, 46703, 47262, 
    47575, 47879, 48689, 49180, 49435, 49770, 50098, 50061, 50172, 50322, 49914, 50621, 50889, 51133, 50967, 
    50614, 50791, 50486, 50436, 50436, 50141, 49793, 49238, 49192, 48815, 48508, 48174, 48085, 48120, 47919, 
    47826, 47659, 47661, 47462, 47482, 47411, 47337, 47347, 47410, 47508, 47310, 46962, 46372, 46485, 46458, 
    46863, 46319, 46254, 46084, 45662, 45394, 45434, 44420, 43927, 43610, 43120, 43055, 42620, 42073, 41429, 
    40877, 40403, 39587, 39528, 39122, 38959, 38446, 37793, 37276, 37041, 36711, 36111, 35729, 35228, 34459, 
    33699, 32797, 32264, 31765, 30635, 30022, 29591, 29333, 28658, 28465, 27480, 27308, 27656, 27286, 27718, 
    27857, 28578, 28894, 29711, 30275, 30852, 30688, 30935, 30800, 30791, 30248, 29583, 30374, 37503, 36941, 
    37476, 37027, 37396, 37100, 37328, 37162, 37274, 37208, 37236, 37238, 37215, 37251, 37208, 37253, 37210, 
    37248, 37217, 37240, 37224, 37234, 37229, 37230, 37231, 37229, 37232, 37229, 37232, 37229, 37231, 37230, 
    37231, 37230, 37230, 37230, 37230
};


// OpCodes
enum OpCode 
{
    OP_INIT_CONN = 1,
    OP_RESET_WATCHDOG = 2,
    OP_START_STREAMING = 3,
    OP_STOP_STREAMING = 4
};

// Error codes (payload for error packets)
enum ERR_CODE
{
    ERR_BAD_CHECKSUM = 0,
    ERR_PAYLOAD_LENGTH_EXCEEDS_MAX = 1,
    ERR_BAD_PACKET_TYPE = 2,
    ERR_BAD_OPCODE = 3,
    ERR_ALREADY_CONNECTED = 4,
    ERR_NOT_CONNECTED = 5,
    ERR_ALREADY_STREAMING = 6,
    ERR_ALREADY_STOP_STREAMING = 7,
};

// Different packet types that can be sent/received
enum PacketType 
{
    PKT_FAILURE = 0,
    PKT_TRANSACTION = 1,
    PKT_STREAM = 2
};

// Packet struct
typedef struct packet
{
    byte headerSync[3];
    byte packetType;
    byte packetID;
    byte payloadSize;
    byte payload[MAX_PAYLOAD_LENGTH];
    byte checkSum;
} packet_t;

// Status buffers for reading packets
int headerBytesReceived;
int payloadBytesReceived;
byte checkSum;

// Different packets (failure, transaction, and streaming)
packet_t
    failResp = {.headerSync = {0xAA, 0x01, 0x02}, .packetType=PKT_FAILURE, .packetID=0, .payloadSize=1},
    transactionBuffer,
    streamBuffer = {.headerSync = {0xAA, 0x01, 0x02}, .packetType=PKT_STREAM, .packetID=0, .payloadSize=6};

// Miscellaneous variables to control streaming and system status as well as periodic dropouts
unsigned long startTime, timeNowMicroseconds, lastStreamPacketTime, timestamp;
unsigned short eegSample;

bool isValidPacket;
bool isConnected;
bool isStreaming;

// Resets Arduino
void (*_softReset)(void) = NULL;

// Computes and returns checksum based on the packet passed 
byte calcChecksum(packet_t *packet) 
{
    byte sum = 0xAD + packet->packetID + packet->packetType + packet->payloadSize;
    for (int i = 0; i < packet->payloadSize; i++)
    {
        sum += packet->payload[i];
    }

    return sum;
}

// This function constructs a packet using header, payload, and calculated checksum and sends packet over serial
void sendPacket(packet_t *packet)
{
    Serial.write(packet->headerSync, 3); // Write the header sync
    Serial.write(&(packet->packetType), 1);
    Serial.write(&(packet->packetID), 1);
    Serial.write(&(packet->payloadSize), 1);
    Serial.write(packet->payload, packet->payloadSize); // Write the body
    Serial.write(&(packet->checkSum), 1); // Write the checksum
}

// Resets global variables associated with status buffers
void resetStatusBuffers()
{
    headerBytesReceived = 0;
    payloadBytesReceived = 0;
    checkSum = 0;
}

// Sends error packet according to the given error opcode
void sendErrorPacket(byte code)
{
    failResp.packetID = transactionBuffer.packetID;
    failResp.payload[0] = code;
    failResp.checkSum = calcChecksum(&failResp);
    sendPacket(&failResp);
}

// Echos connection packet if not connected, otherwise echos error packet
void initConn(void) 
{
    if (isConnected)
    {
        sendErrorPacket(ERR_ALREADY_CONNECTED);
        return;
    }
    isConnected = true;
    sendPacket(&transactionBuffer);
}

// Echoes watchdog reset packet if connected, otherwise echos error packet
void watchdogReset(void) 
{
    if (!isConnected) 
    {
        sendErrorPacket(ERR_NOT_CONNECTED);
        return;
    }
    
    wdt_reset();        
    sendPacket(&transactionBuffer);
}

// Echos streaming packet if not connected, otherwise echos error packet
void startStreaming(void)
{
    if (!isConnected)
    {
        sendErrorPacket(ERR_NOT_CONNECTED);
        return;
    }
    
    if (isStreaming)
    {
        sendErrorPacket(ERR_ALREADY_STREAMING);
        return;
    }
    
    isStreaming = true;
    sendPacket(&transactionBuffer);
}

// Echos stop streaming packet if not connected, otherwise echos error packet
void stopStreaming(void)
{
    if (!isConnected)
    {
        sendErrorPacket(ERR_NOT_CONNECTED);
        return;
    }
    
    if (!isStreaming)
    {
        sendErrorPacket(ERR_ALREADY_STOP_STREAMING);
        return;
    }
    
    isStreaming = false;
    sendPacket(&transactionBuffer);
}

// Executes command based on the opCode (payload)
void executeCommand(byte opCode)
{
    if (opCode == OP_INIT_CONN)
    {
        initConn();                       // If unrecognized already connected, return error accordingly
    }
    else if (opCode == OP_RESET_WATCHDOG)
    {
        watchdogReset();
    }
    else if (opCode == OP_START_STREAMING) 
    {
        startStreaming();                 // If streaming already started, return error accordingly
    }
    else if (opCode == OP_STOP_STREAMING)
    {
        stopStreaming();                  // If streaming already stopped, return error accordingly
    }
    else
    {
        sendErrorPacket(ERR_BAD_OPCODE);  // If unrecognized op code, return error accordingly
    }
}

void setup()
{
    wdt_disable();
    delay(3000);  /* Done so that the Arduino doesn't keep resetting infinitely in case of wrong configuration */
    wdt_enable(WDTO_8S); /* Enable the watchdog with a timeout of 8 seconds */ 
    
    // Set initial baud rate to default value
    Serial.begin(BAUDRATE);

    resetStatusBuffers();
    eeg_index = 0;
    isValidPacket = false;
    isConnected = false;
    isStreaming = false;
    
    startTime = millis();

}

void loop()
{  
    // Unexpected disconnect every 1 minute - reset everything.
    if (millis() - startTime >= 60000)
    {
        _softReset();
    }

    
    if (isStreaming)
    {
        timeNowMicroseconds = micros();
        if (timeNowMicroseconds - lastStreamPacketTime >= STREAM_PERIOD_MICROS)
        {           
            timestamp = millis() - startTime;  // Record current time
            eegSample = pgm_read_word_near(EEG_DATA + eeg_index);  // Read in a sample from flash memory

            // Copy the timestamp bytes (4 bytes) and eeg sample bytes (2 bytes) into the payload
            memcpy(streamBuffer.payload, &timestamp, 4);
            memcpy(&(streamBuffer.payload[4]), &eegSample, 2);

            streamBuffer.checkSum = calcChecksum(&streamBuffer);
            sendPacket(&streamBuffer);
            streamBuffer.packetID++;

            // Increment to the next prerecorded sample. Wrap around if necessary.
            eeg_index = (eeg_index + 1) % EEG_DATA_LENGTH;
            
            lastStreamPacketTime = timeNowMicroseconds;
        }
    }

    // Check if a transaction occurred, execute the pending command
    if (isValidPacket)
    {
        executeCommand(transactionBuffer.payload[0]);

        resetStatusBuffers();
        isValidPacket = false;
    }
}

void serialEvent()
{
    while (Serial.available())
    {
        if (headerBytesReceived < 3)
        {
            // Try to read in the header sync
            if (Serial.readBytes(transactionBuffer.headerSync + headerBytesReceived, 1))
            {
                if (transactionBuffer.headerSync[headerBytesReceived] != expectedHeaderSync[headerBytesReceived])
                {
                    resetStatusBuffers();
                    continue;
                }
                checkSum += transactionBuffer.headerSync[headerBytesReceived];
                headerBytesReceived++;
            }
        }
        else if (headerBytesReceived == 3)
        {
            // Get the packet type
            if (Serial.readBytes(&transactionBuffer.packetType, 1))
            {
                if (transactionBuffer.packetType != PKT_TRANSACTION) 
                {
                    // Packet type invalid. Not a valid packet.
                    resetStatusBuffers();
                    sendErrorPacket(ERR_BAD_PACKET_TYPE);
                    continue;
                }
                checkSum += transactionBuffer.packetType;
                headerBytesReceived++;
            }
        }
        else if (headerBytesReceived == 4)
        {
            // Get the packet ID
            if (Serial.readBytes(&transactionBuffer.packetID, 1))
            {
                checkSum += transactionBuffer.packetID;
                headerBytesReceived++;
            }
        }
        else if (headerBytesReceived == 5)
        {
            if (Serial.readBytes(&transactionBuffer.payloadSize, 1))
            {
                if (transactionBuffer.payloadSize > MAX_PAYLOAD_LENGTH) 
                {
                    // Payload length too big. Not a valid packet.
                    resetStatusBuffers();
                    sendErrorPacket(ERR_PAYLOAD_LENGTH_EXCEEDS_MAX);
                    continue;
                }
                checkSum += transactionBuffer.payloadSize;
                headerBytesReceived++;
            }
        }
        else
        {
            if (payloadBytesReceived < transactionBuffer.payloadSize)
            {
                if (Serial.readBytes(transactionBuffer.payload + payloadBytesReceived, 1))
                {
                    checkSum += transactionBuffer.payload[payloadBytesReceived];
                    payloadBytesReceived++;
                }
            }
            else
            {
                if (Serial.readBytes(&(transactionBuffer.checkSum), 1))
                {
                    if (checkSum != transactionBuffer.checkSum)
                    {
                        resetStatusBuffers();
                        sendErrorPacket(ERR_BAD_CHECKSUM);
                        continue;
                    }
                    resetStatusBuffers();                    
                    isValidPacket = true;
                    return;
                }
            }
        }
    }
}
